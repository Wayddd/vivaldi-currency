<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vivaldi Multi-Currency</title>
    <style>
        :root { --bg: rgba(255, 255, 255, 0.1); --text: #eee; --accent: #3f51b5; }
        @media (prefers-color-scheme: light) { :root { --bg: rgba(0, 0, 0, 0.05); --text: #333; } }
        
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 12px; color: var(--text); background: transparent; }
        .widget { background: var(--bg); backdrop-filter: blur(10px); border-radius: 12px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .currency-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        input, select { background: var(--bg); border: 1px solid rgba(128,128,128,0.2); color: inherit; padding: 8px; border-radius: 6px; font-size: 14px; outline: none; }
        input { flex: 1; width: 60px; }
        select { width: 90px; cursor: pointer; }
        
        .btn { border: none; border-radius: 6px; cursor: pointer; padding: 8px 12px; font-weight: bold; transition: 0.2s; background: var(--accent); color: white; }
        .btn-add { width: 100%; margin-top: 5px; background: rgba(128,128,128,0.2); color: var(--text); }
        .btn-del { background: rgba(255, 0, 0, 0.2); color: #ff5555; padding: 8px 10px; }
        .btn:hover { filter: brightness(1.2); }
    </style>
</head>
<body>

<div class="widget" id="app">
    <div id="rows-container"></div>
    <button class="btn btn-add" onclick="addRow()">+ Добавить валюту</button>
</div>

<script>
    let rates = {};
    const container = document.getElementById('rows-container');
    const API_URL = 'https://open.er-api.com/v6/latest/USD';

    // Список популярных валют для начала (можно менять)
    let activeCurrencies = ['USD', 'RUB', 'KZT'];

    async function init() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            rates = data.rates;
            
            // Отрисовываем начальные строки
            activeCurrencies.forEach(code => addRow(code));
            updateAll(null, 1, 'USD'); 
        } catch (e) { alert("Ошибка загрузки курсов"); }
    }

    function addRow(selectedCode = 'USD') {
        const row = document.createElement('div');
        row.className = 'currency-row';
        
        const codes = Object.keys(rates).sort();
        const options = codes.map(c => `<option value="${c}" ${c === selectedCode ? 'selected' : ''}>${c}</option>`).join('');

        row.innerHTML = `
            <input type="number" step="any" class="amount-input" value="1" oninput="handleInput(this)">
            <select onchange="handleInput(this)">${options}</select>
            ${container.children.length > 1 ? '<button class="btn btn-del" onclick="this.parentElement.remove()">×</button>' : '<span>&nbsp;&nbsp;&nbsp;&nbsp;</span>'}
        `;
        container.appendChild(row);
        if (rates['USD']) handleInput(container.querySelector('input'));
    }

    function handleInput(el) {
        const row = el.closest('.currency-row');
        const amount = parseFloat(row.querySelector('input').value) || 0;
        const code = row.querySelector('select').value;
        updateAll(row, amount, code);
    }

    function updateAll(sourceRow, amount, fromCode) {
        const amountInUsd = amount / rates[fromCode];
        document.querySelectorAll('.currency-row').forEach(row => {
            if (row === sourceRow) return;
            const targetCode = row.querySelector('select').value;
            const targetInput = row.querySelector('input');
            const result = amountInUsd * rates[targetCode];
            targetInput.value = result > 1 ? result.toFixed(2) : result.toFixed(4);
        });
    }

    init();
</script>
</body>
</html>
